{% extends "base.html" %}

{% block title %}Community Forum - AgriSuper{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/forum.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="row mb-3">
        <div class="col-12">
            {% for category, message in messages %}
            <div class="alert alert-{{ category if category != 'error' else 'danger' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endwith %}
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Forum Header -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Community Forum</h5>
                    <div class="d-flex">
                        <div class="input-group input-group-sm me-2 sort-selector-container">
                            <span class="input-group-text">Sort By</span>
                            <select class="form-select form-select-sm" id="sortSelector" name="sortBy" aria-label="Sort discussions by">
                                <option selected>Recent</option>
                                <option>Popular</option>
                                <option>Trending</option>
                                <option>Unanswered</option>
                            </select>
                        </div>
                        <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#newPostModal">
                            <i class="fas fa-plus-circle me-1"></i>New Post
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Search and Filter -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="input-group forum-search">
                                <input type="text" class="form-control" placeholder="Search discussions..." aria-label="Search discussions">
                                <button class="btn btn-success" type="button" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="categoryFilter" name="category" aria-label="Filter by category">
                                <option selected>All Categories</option>
                                <option>Crop Management</option>
                                <option>Soil Health</option>
                                <option>Equipment</option>
                                <option>Market Prices</option>
                                <option>Weather</option>
                                <option>General Discussion</option>
                                <option>Questions & Answers</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Discussion Threads -->
                    <div class="list-group mb-4">
                        {% for question in questions[:10] %}
                        <div class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <h5 class="mb-1">
                                    <span class="badge bg-success me-2">{{ question.category }}</span>
                                    <a href="{{ url_for('view_question', question_id=question.id) }}" class="text-decoration-none text-dark">{{ question.title }}</a>
                                </h5>
                                <small class="text-muted">{{ question.posted_date }}</small>
                            </div>
                            <p class="mb-1">{{ question.question|truncate(150) }}</p>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <div>
                                    <small class="text-muted me-3">
                                        <i class="fas fa-user me-1"></i>{{ question.farmer_name }}
                                    </small>
                                    <small class="text-muted me-3">
                                        <i class="fas fa-comment me-1"></i>{{ question.answers|length }} replies
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-eye me-1"></i>{{ question.views }} views
                                    </small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-success me-1">
                                        <i class="fas fa-thumbs-up me-1"></i>{{ question.likes }}
                                    </button>
                                    <a href="{{ url_for('view_question', question_id=question.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-reply me-1"></i>Reply
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                        
                        <!-- Thread 3 -->
                        <div class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <h5 class="mb-1">
                                    <span class="badge bg-warning text-dark me-2">Equipment</span>
                                    Recommendations for small-scale irrigation systems
                                </h5>
                                <small class="text-muted">5 hours ago</small>
                            </div>
                            <p class="mb-1">I have a 2-acre vegetable farm and looking to install an efficient irrigation system. Budget is around ₹50,000. What options should I consider for water conservation and ease of use?</p>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <div>
                                    <small class="text-muted me-3">
                                        <i class="fas fa-user me-1"></i>Mohan Singh
                                    </small>
                                    <small class="text-muted me-3">
                                        <i class="fas fa-comment me-1"></i>4 replies
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-eye me-1"></i>42 views
                                    </small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-success me-1">
                                        <i class="fas fa-thumbs-up me-1"></i>7
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-reply me-1"></i>Reply
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Thread 4 -->
                        <div class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <h5 class="mb-1">
                                    <span class="badge bg-danger text-white me-2">Soil Health</span>
                                    Dealing with soil salinity in coastal farming areas
                                </h5>
                                <small class="text-muted">1 week ago</small>
                            </div>
                            <p class="mb-1">My farm is located near the coast and I'm struggling with increasing soil salinity. Crop yields have decreased by almost 30% in the last two seasons. Has anyone successfully managed this issue?</p>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <div>
                                    <small class="text-muted me-3">
                                        <i class="fas fa-user me-1"></i>Priya Patel
                                    </small>
                                    <small class="text-muted me-3">
                                        <i class="fas fa-comment me-1"></i>21 replies
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-eye me-1"></i>203 views
                                    </small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-success me-1">
                                        <i class="fas fa-thumbs-up me-1"></i>32
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-reply me-1"></i>Reply
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Thread 5 -->
                        <div class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <h5 class="mb-1">
                                    <span class="badge bg-primary me-2">Weather</span>
                                    Preparing for the upcoming monsoon season
                                </h5>
                                <small class="text-muted">2 days ago</small>
                            </div>
                            <p class="mb-1">Meteorological department has predicted heavy rainfall this monsoon. What preparations are you making to protect crops and prevent waterlogging? Any specific drainage solutions that work well?</p>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <div>
                                    <small class="text-muted me-3">
                                        <i class="fas fa-user me-1"></i>Sunil Verma
                                    </small>
                                    <small class="text-muted me-3">
                                        <i class="fas fa-comment me-1"></i>16 replies
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-eye me-1"></i>178 views
                                    </small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-success me-1">
                                        <i class="fas fa-thumbs-up me-1"></i>29
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-reply me-1"></i>Reply
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pagination -->
                    <nav aria-label="Discussion pagination">
                        <ul class="pagination justify-content-center">
                            <li class="page-item">
                                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
            
            <!-- Featured Discussion -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-star me-2"></i>Featured Discussion</h5>
                </div>
                <div class="card-body">
                    <h5 class="card-title">Organic Farming Certification Process: A Step-by-Step Guide</h5>
                    <div class="mb-3">
                        <span class="badge bg-success me-2">Organic Farming</span>
                        <small class="text-muted">Posted by Dr. Sharma (Agricultural Scientist) • 2 weeks ago</small>
                    </div>
                    <p class="card-text">Many farmers are interested in transitioning to organic farming but find the certification process daunting. In this comprehensive guide, I'll walk you through each step of getting certified, from documentation to inspection...</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted me-3">
                                <i class="fas fa-comment me-1"></i>47 replies
                            </small>
                            <small class="text-muted">
                                <i class="fas fa-eye me-1"></i>512 views
                            </small>
                        </div>
                        <button class="btn btn-sm btn-success">Read Full Discussion</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Community Stats -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Community Stats</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h3 class="mb-0">{{ forum_stats.members }}</h3>
                            <small class="text-muted">Members</small>
                        </div>
                        <div class="col-4">
                            <h3 class="mb-0">{{ forum_stats.questions }}</h3>
                            <small class="text-muted">Discussions</small>
                        </div>
                        <div class="col-4">
                            <h3 class="mb-0">{{ forum_stats.answers }}</h3>
                            <small class="text-muted">Replies</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Top Contributors -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-award me-2"></i>Top Contributors</h5>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <img src="https://via.placeholder.com/40" class="rounded-circle me-2" alt="User">
                                <div>
                                    <h6 class="mb-0">Dr. Sharma</h6>
                                    <small class="text-muted">Agricultural Scientist</small>
                                </div>
                            </div>
                            <span class="badge bg-success rounded-pill">142 posts</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <img src="https://via.placeholder.com/40" class="rounded-circle me-2" alt="User">
                                <div>
                                    <h6 class="mb-0">Rajesh Kumar</h6>
                                    <small class="text-muted">Experienced Farmer</small>
                                </div>
                            </div>
                            <span class="badge bg-success rounded-pill">98 posts</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <img src="https://via.placeholder.com/40" class="rounded-circle me-2" alt="User">
                                <div>
                                    <h6 class="mb-0">Anita Sharma</h6>
                                    <small class="text-muted">Organic Farming Expert</small>
                                </div>
                            </div>
                            <span class="badge bg-success rounded-pill">87 posts</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <img src="https://via.placeholder.com/40" class="rounded-circle me-2" alt="User">
                                <div>
                                    <h6 class="mb-0">Mohan Singh</h6>
                                    <small class="text-muted">Equipment Specialist</small>
                                </div>
                            </div>
                            <span class="badge bg-success rounded-pill">76 posts</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <img src="https://via.placeholder.com/40" class="rounded-circle me-2" alt="User">
                                <div>
                                    <h6 class="mb-0">Priya Patel</h6>
                                    <small class="text-muted">Soil Health Advisor</small>
                                </div>
                            </div>
                            <span class="badge bg-success rounded-pill">65 posts</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Popular Categories -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-tags me-2"></i>Popular Categories</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for category in categories %}
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <span>
                                {% if category == 'Crop Management' %}
                                <i class="fas fa-seedling text-success me-2"></i>
                                {% elif category == 'Weather' %}
                                <i class="fas fa-cloud-rain text-primary me-2"></i>
                                {% elif category == 'Equipment' %}
                                <i class="fas fa-tractor text-warning me-2"></i>
                                {% elif category == 'Market Prices' %}
                                <i class="fas fa-chart-line text-info me-2"></i>
                                {% elif category == 'Soil Health' %}
                                <i class="fas fa-microscope text-danger me-2"></i>
                                {% elif category == 'General Discussion' %}
                                <i class="fas fa-comments text-secondary me-2"></i>
                                {% else %}
                                <i class="fas fa-folder text-secondary me-2"></i>
                                {% endif %}
                                {{ category }}
                            </span>
                            <span class="badge bg-success rounded-pill">{{ category_counts[category] }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Upcoming Events -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Upcoming Events</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Organic Farming Workshop</h6>
                                <small class="text-muted">Aug 15</small>
                            </div>
                            <p class="mb-1 small">Learn practical techniques for transitioning to organic farming methods.</p>
                            <small class="text-muted">Online Webinar • 10:00 AM</small>
                        </div>
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Soil Testing Camp</h6>
                                <small class="text-muted">Aug 22</small>
                            </div>
                            <p class="mb-1 small">Free soil testing for all community members. Bring your soil samples.</p>
                            <small class="text-muted">District Agricultural Office • 9:00 AM - 4:00 PM</small>
                        </div>
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Q&A with Market Experts</h6>
                                <small class="text-muted">Aug 28</small>
                            </div>
                            <p class="mb-1 small">Live discussion about current market trends and price forecasts.</p>
                            <small class="text-muted">Online Webinar • 6:00 PM</small>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <a href="#" class="btn btn-sm btn-outline-success w-100">View All Events</a>
                </div>
            </div>
            
            <!-- Community Guidelines -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Community Guidelines</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Be respectful and supportive of fellow farmers</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Share knowledge and experiences freely</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Provide sources when sharing information</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Keep discussions relevant to agriculture</li>
                        <li><i class="fas fa-check-circle text-success me-2"></i>Report inappropriate content to moderators</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Post Modal -->
<div class="modal fade" id="newPostModal" tabindex="-1" aria-labelledby="newPostModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="newPostModalLabel"><i class="fas fa-plus-circle me-2"></i>Ask a Question</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="/submit-question" method="post" id="questionForm">
                    <div class="mb-3">
                        <label for="postTitle" class="form-label">Question Title</label>
                        <input type="text" class="form-control" id="postTitle" name="title" placeholder="Enter a clear, specific title for your question" required>
                    </div>
                    <div class="mb-3">
                        <label for="postCategory" class="form-label">Category</label>
                        <select class="form-select" id="postCategory" name="category" required>
                            <option value="" selected>Select Category</option>
                            {% for category in categories %}
                            <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="postContent" class="form-label">Question Details</label>
                        <textarea class="form-control" id="postContent" name="question" rows="6" placeholder="Describe your question in detail. Include relevant information to help others understand your question." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="postTags" class="form-label">Tags (optional)</label>
                        <input type="text" class="form-control" id="postTags" name="tags" placeholder="Enter tags separated by commas (e.g., wheat, irrigation, organic)">
                    </div>
                    <div class="mb-3">
                        <label for="postAttachments" class="form-label">Attachments (optional)</label>
                        <input class="form-control" type="file" id="postAttachments" name="attachments" multiple>
                        <div class="form-text">You can upload images or documents related to your question (max 5 files, 5MB each).</div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="notifyReplies" name="notify" checked>
                        <label class="form-check-label" for="notifyReplies">
                            Notify me of replies
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="questionForm" class="btn btn-success">Post Question</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Handle post button click
        $('.modal .btn-success').click(function() {
            // In a real app, this would submit the form data
            $('#newPostModal').modal('hide');
            
            // Show confirmation toast
            showToast('Your discussion has been posted successfully!');
            
            // In a real app, we would refresh the discussions list or add the new post
        });
        
        // Handle reply button clicks
        $('.btn-outline-primary').click(function() {
            if ($(this).find('i').hasClass('fa-reply')) {
                // In a real app, this would open a reply form or navigate to the discussion
                showToast('Reply feature will be implemented soon!');
            }
        });
        
        // Handle like button clicks
        $('.btn-outline-success').click(function() {
            if ($(this).find('i').hasClass('fa-thumbs-up')) {
                // Toggle active state
                $(this).toggleClass('active');
                
                // Update count (this is just a demo - in a real app we'd update the server)
                var currentCount = parseInt($(this).text().trim());
                if ($(this).hasClass('active')) {
                    $(this).html('<i class="fas fa-thumbs-up me-1"></i>' + (currentCount + 1));
                } else {
                    $(this).html('<i class="fas fa-thumbs-up me-1"></i>' + (currentCount - 1));
                }
            }
        });
        
        // Function to show toast notification
        function showToast(message) {
            // Create toast element
            var toast = $('<div class="toast" role="alert" aria-live="assertive" aria-atomic="true">'+
                          '<div class="toast-header bg-success text-white">'+
                          '<strong class="me-auto">Community Forum</strong>'+
                          '<small>Just now</small>'+
                          '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>'+
                          '</div>'+
                          '<div class="toast-body">'+message+'</div>'+
                          '</div>');
            
            // Add to container
            if ($('.toast-container').length === 0) {
                $('body').append('<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>');
            }
            $('.toast-container').append(toast);
            
            // Initialize and show toast
            var toastEl = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 5000
            });
            toastEl.show();
            
            // Remove after hidden
            toast.on('hidden.bs.toast', function() {
                $(this).remove();
            });
        }
    });
</script>
{% endblock %}