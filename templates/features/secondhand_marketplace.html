{% extends "base.html" %}

{% block title %}Secondhand Marketplace - AgriSuper{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0"><i class="fas fa-recycle me-2"></i>Secondhand Marketplace</h4>
                    <p class="mb-0">Buy and sell used agricultural equipment and tools</p>
                </div>
                <div class="card-body">
                    <!-- Action Buttons -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#postListingModal">
                                <i class="fas fa-plus me-2"></i>Post New Listing
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-info w-100" onclick="loadMyListings()">
                                <i class="fas fa-list me-2"></i>My Listings
                            </button>
                        </div>
                    </div>

                    <!-- Search Filters -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label class="form-label" for="category">Category</label>
                            <select class="form-select" id="category" title="Filter by equipment category" aria-label="Select equipment category">
                                <option value="">All Categories</option>
                                <option value="tractors">Tractors</option>
                                <option value="harvesters">Harvesters</option>
                                <option value="tools">Hand Tools</option>
                                <option value="irrigation">Irrigation Equipment</option>
                                <option value="processing">Processing Equipment</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" for="priceRange">Price Range</label>
                            <select class="form-select" id="priceRange" title="Filter by price range" aria-label="Select price range">
                                <option value="">Any Price</option>
                                <option value="0-10000">Under ₹10,000</option>
                                <option value="10000-50000">₹10,000 - ₹50,000</option>
                                <option value="50000-200000">₹50,000 - ₹2,00,000</option>
                                <option value="200000-999999">Above ₹2,00,000</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" id="location" placeholder="Enter location">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary d-block w-100" onclick="searchListings()">
                                <i class="fas fa-search me-2"></i>Search
                            </button>
                        </div>
                    </div>

                    <!-- Listings Grid -->
                    <div id="listingsGrid" class="row">
                        <!-- Listings will be loaded here -->
                    </div>

                    <!-- Post Listing Modal -->
                    <div class="modal fade" id="postListingModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Post New Listing</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close form" aria-label="Close listing form"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="listingForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label" for="itemName">Item Name</label>
                                                <input type="text" class="form-control" id="itemName" required title="Enter item name" placeholder="Enter item name" aria-label="Enter item name">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label" for="itemCategory">Category</label>
                                                <select class="form-select" id="itemCategory" required title="Select item category" aria-label="Select item category">
                                                    <option value="">Select Category</option>
                                                    <option value="tractors">Tractors</option>
                                                    <option value="harvesters">Harvesters</option>
                                                    <option value="tools">Hand Tools</option>
                                                    <option value="irrigation">Irrigation Equipment</option>
                                                    <option value="processing">Processing Equipment</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <label class="form-label" for="price">Price (₹)</label>
                                                <input type="number" class="form-control" id="price" required min="1" title="Enter price in Rupees" placeholder="Enter price" aria-label="Enter price in Rupees">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label" for="condition">Condition</label>
                                                <select class="form-select" id="condition" required title="Select item condition" aria-label="Select item condition">
                                                    <option value="">Select Condition</option>
                                                    <option value="excellent">Excellent</option>
                                                    <option value="good">Good</option>
                                                    <option value="fair">Fair</option>
                                                    <option value="needs_repair">Needs Repair</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <label class="form-label" for="description">Description</label>
                                            <textarea class="form-control" id="description" rows="4" required 
                                                title="Describe your item in detail"
                                                placeholder="Describe the item, its condition, usage history, etc."
                                                aria-label="Item description"></textarea>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <label class="form-label" for="itemLocation">Location</label>
                                                <input type="text" class="form-control" id="itemLocation" required
                                                    title="Enter your location"
                                                    placeholder="Enter your location"
                                                    aria-label="Enter your location">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label" for="contactNumber">Contact Number</label>
                                                <input type="tel" class="form-control" id="contactNumber" required title="Enter your contact number" placeholder="Enter contact number" aria-label="Enter your contact number">
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-success" onclick="postListing()">Post Listing</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Item Details Modal -->
                    <div class="modal fade" id="itemDetailsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="itemDetailsTitle">Item Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close details" aria-label="Close item details"></button>
                                </div>
                                <div class="modal-body" id="itemDetailsBody">
                                    <!-- Item details will be loaded here -->
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-success" id="buyItemBtn" onclick="buyItem()">Contact Seller</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedItem = null;

function searchListings() {
    const filters = {
        category: document.getElementById('category').value,
        price_range: document.getElementById('priceRange').value,
        location: document.getElementById('location').value
    };

    fetch('/api/secondhand/listings?' + new URLSearchParams(filters))
        .then(response => response.json())
        .then(data => {
            displayListings(data.listings || []);
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error loading listings', 'danger');
        });
}

function displayListings(listings) {
    const container = document.getElementById('listingsGrid');
    container.innerHTML = '';

    if (listings.length === 0) {
        container.innerHTML = '<div class="col-12"><div class="alert alert-info">No listings found matching your criteria.</div></div>';
        return;
    }

    listings.forEach(item => {
        const conditionBadge = getConditionBadge(item.condition);
        const card = `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">${item.name}</h5>
                        <div class="mb-2">
                            <span class="badge bg-primary">${item.category}</span>
                            ${conditionBadge}
                        </div>
                        <p class="card-text">${item.description.substring(0, 100)}...</p>
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i>${item.location}
                            </small>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>Posted ${item.posted_date}
                            </small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="h5 text-success mb-0">₹${item.price.toLocaleString()}</div>
                            <button class="btn btn-outline-info btn-sm" onclick="viewItemDetails('${item.id}')">
                                <i class="fas fa-eye me-1"></i>View Details
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += card;
    });
}

function getConditionBadge(condition) {
    const badges = {
        'excellent': '<span class="badge bg-success ms-1">Excellent</span>',
        'good': '<span class="badge bg-info ms-1">Good</span>',
        'fair': '<span class="badge bg-warning ms-1">Fair</span>',
        'needs_repair': '<span class="badge bg-danger ms-1">Needs Repair</span>'
    };
    return badges[condition] || '';
}

function viewItemDetails(itemId) {
    // In a real app, this would fetch item details from the API
    fetch(`/api/secondhand/item/${itemId}`)
        .then(response => response.json())
        .then(data => {
            selectedItem = data.item;
            displayItemDetails(data.item);
            new bootstrap.Modal(document.getElementById('itemDetailsModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error loading item details', 'danger');
        });
}

function displayItemDetails(item) {
    document.getElementById('itemDetailsTitle').textContent = item.name;
    const conditionBadge = getConditionBadge(item.condition);
    
    document.getElementById('itemDetailsBody').innerHTML = `
        <div class="row">
            <div class="col-md-8">
                <h5>₹${item.price.toLocaleString()}</h5>
                <div class="mb-3">
                    <span class="badge bg-primary">${item.category}</span>
                    ${conditionBadge}
                </div>
                <p><strong>Description:</strong></p>
                <p>${item.description}</p>
                <p><strong>Location:</strong> ${item.location}</p>
                <p><strong>Posted:</strong> ${item.posted_date}</p>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Seller Information</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Name:</strong> ${item.seller_name}</p>
                        <p><strong>Rating:</strong> ${'★'.repeat(Math.floor(item.seller_rating))} (${item.seller_rating}/5)</p>
                        <p><strong>Total Sales:</strong> ${item.seller_sales}</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function postListing() {
    const formData = {
        name: document.getElementById('itemName').value,
        category: document.getElementById('itemCategory').value,
        price: parseFloat(document.getElementById('price').value),
        condition: document.getElementById('condition').value,
        description: document.getElementById('description').value,
        location: document.getElementById('itemLocation').value,
        contact_number: document.getElementById('contactNumber').value,
        seller_id: 'user123' // This would come from authentication
    };

    // Validate form
    if (!formData.name || !formData.category || !formData.price || !formData.condition || !formData.description) {
        showAlert('Please fill in all required fields', 'warning');
        return;
    }

    fetch('/api/secondhand/post', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showAlert('Listing posted successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('postListingModal')).hide();
            document.getElementById('listingForm').reset();
            searchListings(); // Refresh listings
        } else {
            showAlert(data.message || 'Error posting listing', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error posting listing', 'danger');
    });
}

function buyItem() {
    if (!selectedItem) return;
    
    const data = {
        item_id: selectedItem.id,
        buyer_id: 'user123' // This would come from authentication
    };

    fetch('/api/secondhand/buy', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showAlert('Seller contact details sent to your registered mobile number', 'success');
            bootstrap.Modal.getInstance(document.getElementById('itemDetailsModal')).hide();
        } else {
            showAlert(data.message || 'Error contacting seller', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error contacting seller', 'danger');
    });
}

function loadMyListings() {
    // Filter to show only user's listings
    document.getElementById('category').value = '';
    document.getElementById('priceRange').value = '';
    document.getElementById('location').value = '';
    
    // In a real app, this would filter by user ID
    searchListings();
    showAlert('Showing all listings. In a real app, this would show only your listings.', 'info');
}

// Load listings on page load
document.addEventListener('DOMContentLoaded', function() {
    searchListings();
});
</script>
{% endblock %}
